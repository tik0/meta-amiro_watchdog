From 4b39440ebdadd3d8d7b5febf5815976f99d3f6e9 Mon Sep 17 00:00:00 2001
From: Stefan Herbrechtsmeier <stefan@herbrechtsmeier.net>
Date: Wed, 21 May 2014 15:41:20 +0200
Subject: [PATCH 6/8] omap3: overo: Select fdtfile depending on expansion board
 detection

Signed-off-by: Stefan Herbrechtsmeier <stefan@herbrechtsmeier.net>
---
 board/overo/overo.c           | 6 ++++++
 include/configs/omap3_overo.h | 6 +++++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/board/overo/overo.c b/board/overo/overo.c
index 0e8098a..ab45576 100644
--- a/board/overo/overo.c
+++ b/board/overo/overo.c
@@ -257,6 +257,7 @@ int misc_init_r(void)
 			expansion_config.revision,
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
+		setenv("expansion", "summit");
 		setenv("defaultdisplay", "dvi");
 		break;
 	case GUMSTIX_TOBI:
@@ -264,6 +265,7 @@ int misc_init_r(void)
 			expansion_config.revision,
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
+		setenv("expansion", "tobi");
 		setenv("defaultdisplay", "dvi");
 		break;
 	case GUMSTIX_TOBI_DUO:
@@ -284,6 +286,7 @@ int misc_init_r(void)
 			expansion_config.revision,
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
+		setenv("expansion", "palo43");
 		setenv("defaultdisplay", "lcd43");
 		break;
 	case GUMSTIX_CHESTNUT43:
@@ -291,6 +294,7 @@ int misc_init_r(void)
 			expansion_config.revision,
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
+		setenv("expansion", "chestnut43");
 		setenv("defaultdisplay", "lcd43");
 		break;
 	case GUMSTIX_PINTO:
@@ -304,6 +308,7 @@ int misc_init_r(void)
 			expansion_config.revision,
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
+		setenv("expansion", "gallop43");
 		setenv("defaultdisplay", "lcd43");
 		break;
 	case GUMSTIX_ALTO35:
@@ -312,6 +317,7 @@ int misc_init_r(void)
 			expansion_config.fab_revision);
 		MUX_GUMSTIX();
 		MUX_ALTO35();
+		setenv("expansion", "alto35");
 		setenv("defaultdisplay", "lcd35");
 		break;
 	case GUMSTIX_STAGECOACH:
diff --git a/include/configs/omap3_overo.h b/include/configs/omap3_overo.h
index ba85d6c..c41da6b 100644
--- a/include/configs/omap3_overo.h
+++ b/include/configs/omap3_overo.h
@@ -91,7 +91,6 @@
 /* Environment information */
 #define CONFIG_EXTRA_ENV_SETTINGS \
 	DEFAULT_LINUX_BOOT_ENV \
-	"fdtfile=overo.dtb\0" \
 	"bootdir=/boot\0" \
 	"bootfile=zImage\0" \
 	"usbtty=cdc_acm\0" \
@@ -161,6 +160,11 @@
 			"run mmcboot;" \
 		"fi;" \
 		"if run loadzimage; then " \
+			"if test -z \"$fdtfile\"; then " \
+				"if test -n $expansion; then " \
+					"setenv fdtfile omap3-overo-${expansion}.dtb;" \
+				"fi;" \
+			"fi;" \
 			"if test -n $fdtfile; then " \
 				"if run loadfdt; then " \
 					"run mmcbootfdt;" \
-- 
2.0.0

